# Docker Compose para pruebas locales simulando Coolify + Traefik
# Este archivo simula el entorno de producción para validar la configuración
# Uso: docker-compose -f docker-compose.test.yml up -d

version: '3.8'

services:
  # Traefik (simulando Coolify)
  traefik:
    image: traefik:v3.0
    container_name: traefik-test
    restart: unless-stopped
    command:
      - "--api.dashboard=true"
      - "--api.insecure=true"
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--entrypoints.web.address=:80"
      - "--entrypoints.websecure.address=:443"
      - "--certificatesresolvers.letsencrypt.acme.tlschallenge=true"
      - "--certificatesresolvers.letsencrypt.acme.email=test@example.com"
      - "--certificatesresolvers.letsencrypt.acme.storage=/letsencrypt/acme.json"
      - "--certificatesresolvers.myresolver.acme.tlschallenge=true"
      - "--certificatesresolvers.myresolver.acme.email=test@example.com"
      - "--certificatesresolvers.myresolver.acme.storage=/letsencrypt/myresolver.json"
      - "--log.level=DEBUG"
    ports:
      - "80:80"
      - "443:443"
      - "8080:8080"  # Dashboard de Traefik
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - traefik_letsencrypt:/letsencrypt
    networks:
      - minimarket-network

  # SQL Server 2022 Database
  db:
    image: mcr.microsoft.com/mssql/server:2022-latest
    container_name: minimarket-db-test
    restart: unless-stopped
    user: root
    environment:
      - ACCEPT_EULA=Y
      - MSSQL_SA_PASSWORD=TestPassword123!
      - MSSQL_PID=Express
    expose:
      - "1433"
    volumes:
      - db_data_test:/var/opt/mssql/data
      - db_log_test:/var/opt/mssql/log
      - db_secrets_test:/var/opt/mssql/secrets
    networks:
      - minimarket-network
    healthcheck:
      test: ["CMD-SHELL", "timeout 5 bash -c '</dev/tcp/localhost/1433' || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 60s

  # Backend API (.NET Core)
  api:
    build:
      context: ./src
      dockerfile: Minimarket.API/Dockerfile
    container_name: minimarket-api-test
    restart: unless-stopped
    expose:
      - "5000"
    environment:
      - ASPNETCORE_ENVIRONMENT=Production
      - ASPNETCORE_URLS=http://+:5000
      - ConnectionStrings__DefaultConnection=Server=db,1433;Database=MinimarketDB;User Id=SA;Password=TestPassword123!;TrustServerCertificate=true;MultipleActiveResultSets=true;Connection Timeout=30;
      - JwtSettings__SecretKey=TestJwtSecretKeyForTestingPurposesOnly12345678901234567890
      - JwtSettings__Issuer=MinimarketAPI
      - JwtSettings__Audience=MinimarketWeb
      - EmailSettings__SmtpServer=smtp.gmail.com
      - EmailSettings__SmtpPort=587
      - EmailSettings__SmtpUser=minimarket.camucha@gmail.com
      - EmailSettings__SmtpPassword=xzloatedigfqgyxi
      - EmailSettings__FromEmail=minimarket.camucha@gmail.com
      - EmailSettings__FromName=Minimarket Camucha
      - BaseUrl=http://localhost
      - FrontendUrl=http://localhost
      - Cors__AllowedOrigins=http://localhost
      - GoogleOAuth__ClientId=259590059487-5k8bk2sor6r9oa02pojkhj5nrd8c9h2e.apps.googleusercontent.com
      - GoogleOAuth__ClientSecret=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
      - GoogleOAuth__RedirectUri=http://localhost/api/auth/google-callback
    volumes:
      - uploads_test:/app/wwwroot/uploads
      - logs_test:/app/logs
    depends_on:
      db:
        condition: service_healthy
    networks:
      - minimarket-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Frontend (Angular + Nginx) - CONFIGURACIÓN DE PRUEBA
  web:
    build:
      context: ./minimarket-web
      dockerfile: Dockerfile
    container_name: minimarket-web-test
    restart: unless-stopped
    # IMPORTANTE: Usar expose (como en coolify.yml) para que Traefik lo detecte
    expose:
      - "80"
    depends_on:
      - api
    networks:
      - minimarket-network
    # Labels de Traefik - CONFIGURACIÓN DE PRUEBA (simulando coolify.yml)
    labels:
      # Habilitar Traefik para este servicio
      - "traefik.enable=true"
      # Redirección HTTP → HTTPS (entrypoint web)
      - "traefik.http.routers.web-http.rule=Host(`localhost`)"
      - "traefik.http.routers.web-http.entrypoints=web"
      - "traefik.http.routers.web-http.middlewares=web-to-websecure-redirect"
      # Middleware para redirección HTTP → HTTPS
      - "traefik.http.middlewares.web-to-websecure-redirect.redirectscheme.scheme=https"
      - "traefik.http.middlewares.web-to-websecure-redirect.redirectscheme.permanent=true"
      # Configuración HTTPS (entrypoint websecure)
      - "traefik.http.routers.web.rule=Host(`localhost`)"
      - "traefik.http.routers.web.entrypoints=websecure"
      - "traefik.http.routers.web.tls=true"
      # PROBAR AMBOS: letsencrypt y myresolver para ver cuál funciona
      - "traefik.http.routers.web.tls.certresolver=letsencrypt"
      # Puerto del servicio
      - "traefik.http.services.web.loadbalancer.server.port=80"
    healthcheck:
      test: ["CMD", "wget", "--spider", "--quiet", "http://127.0.0.1/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s

volumes:
  db_data_test:
  db_log_test:
  db_secrets_test:
  uploads_test:
  logs_test:
  traefik_letsencrypt:

networks:
  minimarket-network:
    driver: bridge

