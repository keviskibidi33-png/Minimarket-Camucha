<div class="relative flex min-h-screen w-full flex-col items-center justify-center bg-background-light dark:bg-background-dark group/design-root overflow-x-hidden" style='font-family: Inter, "Noto Sans", sans-serif;' [@fadeSlide]>
  <div class="w-full max-w-6xl p-6">
    <div class="flex flex-col items-center rounded-xl border border-border-light/50 bg-card-light p-8 shadow-sm dark:border-border-dark/50 dark:bg-card-dark">
      
      <!-- Header -->
      <div class="mb-8 flex flex-col items-center w-full">
        <div class="mb-4">
          <svg class="h-16 w-16 text-primary" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewbox="0 0 24 24">
            <path d="M19 21V5a2 2 0 0 0-2-2H7a2 2 0 0 0-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v5m-4 0h4"></path>
          </svg>
        </div>
        <h1 class="text-3xl font-bold tracking-tight text-text-light dark:text-text-dark">Configuración Inicial</h1>
        <p class="mt-2 text-base text-text-light/70 dark:text-text-dark/70">Configura tu empresa y personaliza tu sistema</p>
      </div>

      <!-- Línea de Tiempo / Progreso -->
      <div class="w-full mb-8">
        <div class="timeline-container flex items-center justify-between relative">
          @for (step of steps; track step.id; let i = $index) {
            <div class="step-wrapper flex flex-col items-center flex-1 relative">
              <!-- Nodo del paso -->
              <div class="step-node-wrapper relative z-10">
                <div class="step-icon flex items-center justify-center w-12 h-12 rounded-full border-2 transition-all cursor-pointer"
                     [class.bg-primary]="currentStep() >= step.id"
                     [class.border-primary]="currentStep() >= step.id"
                     [class.bg-gray-100]="currentStep() < step.id"
                     [class.border-gray-300]="currentStep() < step.id"
                     [class.dark:bg-gray-800]="currentStep() < step.id"
                     [class.dark:border-gray-600]="currentStep() < step.id"
                     (click)="goToStep(step.id)">
                  @if (currentStep() > step.id) {
                    <span class="material-symbols-outlined text-white text-xl">check</span>
                  } @else {
                    <span class="text-sm font-bold"
                          [class.text-primary]="currentStep() === step.id"
                          [class.text-gray-400]="currentStep() < step.id">{{ step.id }}</span>
                  }
                </div>
              </div>
              
              <!-- Etiqueta del paso -->
              <div class="step-label mt-2 text-center">
                <p class="text-xs font-semibold uppercase"
                   [class.text-primary]="currentStep() >= step.id"
                   [class.text-gray-400]="currentStep() < step.id">{{ step.name }}</p>
                <p class="text-xs mt-1"
                   [class.text-text-light]="currentStep() === step.id"
                   [class.text-gray-500]="currentStep() !== step.id"
                   [class.dark:text-text-dark]="currentStep() === step.id"
                   [class.dark:text-gray-400]="currentStep() !== step.id">{{ step.title }}</p>
              </div>

              <!-- Línea conectora (excepto para el último paso) -->
              @if (i < steps.length - 1) {
                <div class="timeline-line absolute top-6 left-[60%] w-full h-0.5 z-0"
                     [class.bg-primary]="currentStep() > step.id"
                     [class.bg-gray-300]="currentStep() <= step.id"
                     [class.dark:bg-gray-600]="currentStep() <= step.id"></div>
              }
            </div>
          }
        </div>
        
        <!-- Barra de progreso -->
        <div class="mt-4 w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2">
          <div class="bg-primary h-2 rounded-full transition-all duration-300" [style.width.%]="progressPercentage"></div>
        </div>
      </div>

      <!-- Formulario -->
      <form [formGroup]="setupForm" (ngSubmit)="onSubmit()" class="w-full">
        
        <!-- PASO 1: Información Básica -->
        @if (currentStep() === 1) {
          <div class="space-y-6">
            <div>
              <h2 class="text-2xl font-bold text-text-light dark:text-text-dark mb-2">Información de tu Empresa</h2>
              <p class="text-sm text-text-light/70 dark:text-text-dark/70">Completa los datos básicos de tu negocio</p>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <!-- Nombre de la Empresa -->
              <div class="md:col-span-2">
                <label class="mb-2 text-sm font-medium text-text-light dark:text-text-dark">Nombre de la Empresa <span class="text-red-500">*</span></label>
                <input
                  class="form-input h-12 w-full rounded-lg border border-border-light bg-background-light py-2 px-3 text-base text-text-light placeholder-placeholder-light ring-primary/50 transition-all duration-200 focus:border-primary focus:outline-none focus:ring-2 dark:border-border-dark dark:bg-background-dark dark:text-text-dark dark:placeholder-placeholder-dark dark:focus:border-primary"
                  type="text"
                  placeholder="Ej: Minimarket Camucha"
                  formControlName="storeName"
                  [class.border-red-500]="setupForm.get('storeName')?.invalid && setupForm.get('storeName')?.touched">
                @if (setupForm.get('storeName')?.invalid && setupForm.get('storeName')?.touched) {
                  <span class="mt-1 text-sm text-red-500">El nombre de la empresa es requerido</span>
                }
              </div>

              <!-- Rubro de Negocio -->
              <div>
                <label class="mb-2 text-sm font-medium text-text-light dark:text-text-dark">Rubro de Negocio <span class="text-red-500">*</span></label>
                <select
                  formControlName="businessType"
                  class="form-input h-12 w-full rounded-lg border border-border-light bg-background-light py-2 px-3 text-base text-text-light ring-primary/50 transition-all duration-200 focus:border-primary focus:outline-none focus:ring-2 dark:border-border-dark dark:bg-background-dark dark:text-text-dark dark:focus:border-primary"
                  [class.border-red-500]="setupForm.get('businessType')?.invalid && setupForm.get('businessType')?.touched">
                  <option value="">Seleccione un rubro</option>
                  @for (type of businessTypes; track type) {
                    <option [value]="type">{{ type }}</option>
                  }
                </select>
                @if (setupForm.get('businessType')?.invalid && setupForm.get('businessType')?.touched) {
                  <span class="mt-1 text-sm text-red-500">El rubro es requerido</span>
                }
              </div>

              <!-- Teléfono de Contacto (Importante, solo una vez) -->
              <div>
                <label class="mb-2 text-sm font-medium text-text-light dark:text-text-dark">Teléfono de Contacto <span class="text-red-500">*</span></label>
                <input
                  class="form-input h-12 w-full rounded-lg border border-border-light bg-background-light py-2 px-3 text-base text-text-light placeholder-placeholder-light ring-primary/50 transition-all duration-200 focus:border-primary focus:outline-none focus:ring-2 dark:border-border-dark dark:bg-background-dark dark:text-text-dark dark:placeholder-placeholder-dark dark:focus:border-primary"
                  type="tel"
                  placeholder="+51 999 999 999"
                  formControlName="phone"
                  [class.border-red-500]="setupForm.get('phone')?.invalid && setupForm.get('phone')?.touched">
                @if (setupForm.get('phone')?.invalid && setupForm.get('phone')?.touched) {
                  <span class="mt-1 text-sm text-red-500">El teléfono es requerido</span>
                }
                <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">Este será el número principal de contacto de tu negocio</p>
              </div>

              <!-- Número de WhatsApp para Notificaciones -->
              <div>
                <label class="mb-2 text-sm font-medium text-text-light dark:text-text-dark">Número de WhatsApp para Notificaciones</label>
                <input
                  class="form-input h-12 w-full rounded-lg border border-border-light bg-background-light py-2 px-3 text-base text-text-light placeholder-placeholder-light ring-primary/50 transition-all duration-200 focus:border-primary focus:outline-none focus:ring-2 dark:border-border-dark dark:bg-background-dark dark:text-text-dark dark:placeholder-placeholder-dark dark:focus:border-primary"
                  type="tel"
                  placeholder="+51 999 999 999"
                  formControlName="whatsAppPhone">
                <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">Número donde se enviarán notificaciones de pedidos a los clientes</p>
              </div>

              <!-- ¿Qué venden? -->
              <div>
                <label class="mb-2 text-sm font-medium text-text-light dark:text-text-dark">¿Qué productos venden?</label>
                <input
                  class="form-input h-12 w-full rounded-lg border border-border-light bg-background-light py-2 px-3 text-base text-text-light placeholder-placeholder-light ring-primary/50 transition-all duration-200 focus:border-primary focus:outline-none focus:ring-2 dark:border-border-dark dark:bg-background-dark dark:text-text-dark dark:placeholder-placeholder-dark dark:focus:border-primary"
                  type="text"
                  placeholder="Ej: Productos de consumo diario, abarrotes..."
                  formControlName="whatSells">
              </div>

              <!-- Descripción -->
              <div class="md:col-span-2">
                <label class="mb-2 text-sm font-medium text-text-light dark:text-text-dark">Descripción del Negocio</label>
                <textarea
                  class="form-input w-full rounded-lg border border-border-light bg-background-light py-2 px-3 text-base text-text-light placeholder-placeholder-light ring-primary/50 transition-all duration-200 focus:border-primary focus:outline-none focus:ring-2 dark:border-border-dark dark:bg-background-dark dark:text-text-dark dark:placeholder-placeholder-dark dark:focus:border-primary"
                  rows="3"
                  placeholder="Describe tu negocio..."
                  formControlName="description"></textarea>
              </div>

              <!-- ¿Es Virtual? -->
              <div class="md:col-span-2">
                <label class="flex items-center gap-3 cursor-pointer">
                  <input
                    type="checkbox"
                    formControlName="isVirtual"
                    class="h-5 w-5 rounded border-border-light text-primary focus:ring-2 focus:ring-primary/50 dark:border-border-dark accent-primary">
                  <span class="text-sm font-medium text-text-light dark:text-text-dark">Mi negocio es solo virtual (sin ubicación física)</span>
                </label>
                <p class="text-xs text-gray-500 dark:text-gray-400 mt-1 ml-8">
                  @if (setupForm.get('isVirtual')?.value) {
                    <span class="text-green-600 dark:text-green-400">✓ Negocio virtual seleccionado. No se requiere información de ubicación física.</span>
                  } @else {
                    <span>Si tu negocio tiene ubicación física, completa los datos de ubicación a continuación.</span>
                  }
                </p>
              </div>

              <!-- Información de Sede (si no es virtual) -->
              @if (!setupForm.get('isVirtual')?.value) {
                <div class="md:col-span-2 border-t border-border-light dark:border-border-dark pt-4 mt-4">
                  <h3 class="text-lg font-semibold text-text-light dark:text-text-dark mb-2">Ubicación de la Sede</h3>
                  <p class="text-xs text-gray-500 dark:text-gray-400 mb-4">Como tu negocio tiene ubicación física, completa estos datos para que los clientes puedan encontrarte.</p>
                  
                  <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="md:col-span-2">
                      <label class="mb-2 text-sm font-medium text-text-light dark:text-text-dark">Dirección <span class="text-red-500">*</span></label>
                      <input
                        class="form-input h-12 w-full rounded-lg border border-border-light bg-background-light py-2 px-3 text-base text-text-light placeholder-placeholder-light ring-primary/50 transition-all duration-200 focus:border-primary focus:outline-none focus:ring-2 dark:border-border-dark dark:bg-background-dark dark:text-text-dark dark:placeholder-placeholder-dark dark:focus:border-primary"
                        type="text"
                        placeholder="Av. Principal 123"
                        formControlName="sedeAddress"
                        [class.border-red-500]="!setupForm.get('sedeAddress')?.value?.trim() && setupForm.get('sedeAddress')?.touched">
                      @if (!setupForm.get('sedeAddress')?.value?.trim() && setupForm.get('sedeAddress')?.touched) {
                        <span class="mt-1 text-sm text-red-500">La dirección es requerida para negocios con ubicación física</span>
                      }
                    </div>

                    <div>
                      <label class="mb-2 text-sm font-medium text-text-light dark:text-text-dark">Ciudad <span class="text-red-500">*</span></label>
                      <input
                        class="form-input h-12 w-full rounded-lg border border-border-light bg-background-light py-2 px-3 text-base text-text-light placeholder-placeholder-light ring-primary/50 transition-all duration-200 focus:border-primary focus:outline-none focus:ring-2 dark:border-border-dark dark:bg-background-dark dark:text-text-dark dark:placeholder-placeholder-dark dark:focus:border-primary"
                        type="text"
                        placeholder="Lima"
                        formControlName="sedeCity"
                        [class.border-red-500]="!setupForm.get('sedeCity')?.value?.trim() && setupForm.get('sedeCity')?.touched">
                      @if (!setupForm.get('sedeCity')?.value?.trim() && setupForm.get('sedeCity')?.touched) {
                        <span class="mt-1 text-sm text-red-500">La ciudad es requerida para negocios con ubicación física</span>
                      }
                    </div>

                    <div>
                      <label class="mb-2 text-sm font-medium text-text-light dark:text-text-dark">Región/Departamento</label>
                      <input
                        class="form-input h-12 w-full rounded-lg border border-border-light bg-background-light py-2 px-3 text-base text-text-light placeholder-placeholder-light ring-primary/50 transition-all duration-200 focus:border-primary focus:outline-none focus:ring-2 dark:border-border-dark dark:bg-background-dark dark:text-text-dark dark:placeholder-placeholder-dark dark:focus:border-primary"
                        type="text"
                        placeholder="Lima"
                        formControlName="sedeRegion">
                    </div>
                  </div>
                </div>
              }
            </div>
          </div>
        }

        <!-- PASO 2: Personalización / Branding -->
        @if (currentStep() === 2) {
          <div class="space-y-6">
            <div>
              <h2 class="text-2xl font-bold text-text-light dark:text-text-dark mb-2">Personalización y Branding</h2>
              <p class="text-sm text-text-light/70 dark:text-text-dark/70">Personaliza la apariencia de tu tienda</p>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <!-- Logo -->
              <div>
                <label class="mb-2 text-sm font-medium text-text-light dark:text-text-dark">Logo de la Empresa</label>
                <input
                  type="file"
                  accept="image/*"
                  (change)="onLogoSelected($event)"
                  class="form-input h-12 w-full rounded-lg border border-border-light bg-background-light py-2 px-3 text-base text-text-light ring-primary/50 transition-all duration-200 focus:border-primary focus:outline-none focus:ring-2 dark:border-border-dark dark:bg-background-dark dark:text-text-dark dark:focus:border-primary">
                <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">Recomendado: PNG o JPG, máximo 2MB</p>
              </div>

              <!-- Favicon -->
              <div>
                <label class="mb-2 text-sm font-medium text-text-light dark:text-text-dark">Favicon</label>
                <input
                  type="file"
                  accept="image/*"
                  (change)="onFaviconSelected($event)"
                  class="form-input h-12 w-full rounded-lg border border-border-light bg-background-light py-2 px-3 text-base text-text-light ring-primary/50 transition-all duration-200 focus:border-primary focus:outline-none focus:ring-2 dark:border-border-dark dark:bg-background-dark dark:text-text-dark dark:focus:border-primary">
                <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">Recomendado: ICO o PNG 32x32px</p>
              </div>

              <!-- Color Primario -->
              <div>
                <label class="mb-2 text-sm font-medium text-text-light dark:text-text-dark">Color Primario <span class="text-red-500">*</span></label>
                <div class="flex gap-2">
                  <input
                    type="color"
                    formControlName="primaryColor"
                    class="h-12 w-20 rounded-lg border border-border-light cursor-pointer dark:border-border-dark">
                  <input
                    type="text"
                    formControlName="primaryColor"
                    class="form-input h-12 flex-1 rounded-lg border border-border-light bg-background-light py-2 px-3 text-base text-text-light ring-primary/50 transition-all duration-200 focus:border-primary focus:outline-none focus:ring-2 dark:border-border-dark dark:bg-background-dark dark:text-text-dark dark:focus:border-primary"
                    placeholder="#4CAF50">
                </div>
              </div>

              <!-- Color Secundario -->
              <div>
                <label class="mb-2 text-sm font-medium text-text-light dark:text-text-dark">Color Secundario <span class="text-red-500">*</span></label>
                <div class="flex gap-2">
                  <input
                    type="color"
                    formControlName="secondaryColor"
                    class="h-12 w-20 rounded-lg border border-border-light cursor-pointer dark:border-border-dark">
                  <input
                    type="text"
                    formControlName="secondaryColor"
                    class="form-input h-12 flex-1 rounded-lg border border-border-light bg-background-light py-2 px-3 text-base text-text-light ring-primary/50 transition-all duration-200 focus:border-primary focus:outline-none focus:ring-2 dark:border-border-dark dark:bg-background-dark dark:text-text-dark dark:focus:border-primary"
                    placeholder="#0d7ff2">
                </div>
              </div>

              <!-- Email -->
              <div>
                <label class="mb-2 text-sm font-medium text-text-light dark:text-text-dark">Email de Contacto</label>
                <input
                  class="form-input h-12 w-full rounded-lg border border-border-light bg-background-light py-2 px-3 text-base text-text-light placeholder-placeholder-light ring-primary/50 transition-all duration-200 focus:border-primary focus:outline-none focus:ring-2 dark:border-border-dark dark:bg-background-dark dark:text-text-dark dark:placeholder-placeholder-dark dark:focus:border-primary"
                  type="email"
                  placeholder="contacto@empresa.com"
                  formControlName="email">
              </div>

              <!-- RUC -->
              <div>
                <label class="mb-2 text-sm font-medium text-text-light dark:text-text-dark">RUC</label>
                <input
                  class="form-input h-12 w-full rounded-lg border border-border-light bg-background-light py-2 px-3 text-base text-text-light placeholder-placeholder-light ring-primary/50 transition-all duration-200 focus:border-primary focus:outline-none focus:ring-2 dark:border-border-dark dark:bg-background-dark dark:text-text-dark dark:placeholder-placeholder-dark dark:focus:border-primary"
                  type="text"
                  placeholder="20123456789"
                  formControlName="ruc">
              </div>

              <!-- Slogan -->
              <div>
                <label class="mb-2 text-sm font-medium text-text-light dark:text-text-dark">Slogan</label>
                <input
                  class="form-input h-12 w-full rounded-lg border border-border-light bg-background-light py-2 px-3 text-base text-text-light placeholder-placeholder-light ring-primary/50 transition-all duration-200 focus:border-primary focus:outline-none focus:ring-2 dark:border-border-dark dark:bg-background-dark dark:text-text-dark dark:placeholder-placeholder-dark dark:focus:border-primary"
                  type="text"
                  placeholder="Tu slogan aquí"
                  formControlName="slogan">
              </div>
            </div>
          </div>
        }

        <!-- PASO 3: Configuración del Sistema -->
        @if (currentStep() === 3) {
          <div class="space-y-6">
            <div>
              <h2 class="text-2xl font-bold text-text-light dark:text-text-dark mb-2">Configuración del Sistema</h2>
              <p class="text-sm text-text-light/70 dark:text-text-dark/70">Configura las categorías y el tamaño de tu sistema</p>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <!-- Categorías -->
              <div class="md:col-span-2">
                <div class="flex items-center justify-between mb-2">
                  <label class="text-sm font-medium text-text-light dark:text-text-dark">Categorías de Productos <span class="text-red-500">*</span></label>
                  <button
                    type="button"
                    (click)="showNewCategoryForm.set(!showNewCategoryForm())"
                    class="px-3 py-1.5 text-xs font-semibold bg-primary text-white rounded-lg hover:bg-primary/90 flex items-center gap-1">
                    <span class="material-symbols-outlined text-sm">add</span>
                    {{ showNewCategoryForm() ? 'Cancelar' : 'Nueva Categoría' }}
                  </button>
                </div>
                <p class="text-xs text-gray-500 dark:text-gray-400 mb-3">Selecciona las categorías que tendrá tu tienda o crea nuevas</p>
                
                <!-- Formulario para crear nueva categoría -->
                @if (showNewCategoryForm()) {
                  <div class="mb-4 p-3 border border-primary/30 dark:border-primary/50 rounded-lg bg-primary/5 dark:bg-primary/10">
                    <div class="flex gap-2">
                      <input
                        type="text"
                        [value]="newCategoryName()"
                        (input)="newCategoryName.set($any($event.target).value)"
                        (keyup.enter)="addCustomCategory()"
                        placeholder="Nombre de la categoría"
                        class="flex-1 form-input h-9 rounded-lg border border-border-light bg-background-light py-1.5 px-3 text-sm text-text-light placeholder-placeholder-light ring-primary/50 transition-all duration-200 focus:border-primary focus:outline-none focus:ring-2 dark:border-border-dark dark:bg-background-dark dark:text-text-dark dark:placeholder-placeholder-dark dark:focus:border-primary">
                      <button
                        type="button"
                        (click)="addCustomCategory()"
                        [disabled]="!newCategoryName().trim()"
                        class="px-3 py-1.5 text-xs font-semibold bg-primary text-white rounded-lg hover:bg-primary/90 disabled:opacity-50 disabled:cursor-not-allowed">
                        Agregar
                      </button>
                    </div>
                  </div>
                }
                
                <!-- Categorías predefinidas -->
                <div class="mb-4">
                  <p class="text-xs font-medium text-gray-600 dark:text-gray-400 mb-2">Categorías Predefinidas</p>
                  <div class="grid grid-cols-2 md:grid-cols-3 gap-3 p-4 border border-border-light dark:border-border-dark rounded-lg bg-background-light dark:bg-background-dark">
                    @for (category of predefinedCategories; track category; let i = $index) {
                      <label class="flex items-center gap-2 cursor-pointer p-2 rounded hover:bg-primary/5 transition-colors">
                        <input
                          type="checkbox"
                          [formControl]="getCategoryControl(i)"
                          class="h-4 w-4 rounded border-border-light text-primary focus:ring-2 focus:ring-primary/50 dark:border-border-dark accent-primary">
                        <span class="text-sm text-text-light dark:text-text-dark">{{ category }}</span>
                      </label>
                    }
                  </div>
                </div>
                
                <!-- Categorías personalizadas -->
                @if (customCategories().length > 0) {
                  <div class="mb-4">
                    <p class="text-xs font-medium text-gray-600 dark:text-gray-400 mb-2">Categorías Personalizadas</p>
                    <div class="flex flex-wrap gap-2">
                      @for (category of customCategories(); track category) {
                        <span class="inline-flex items-center gap-1.5 px-3 py-1.5 bg-primary/10 dark:bg-primary/20 text-primary dark:text-primary border border-primary/30 dark:border-primary/50 rounded-lg text-sm">
                          {{ category }}
                          <button
                            type="button"
                            (click)="removeCustomCategory(category)"
                            class="text-primary hover:text-primary/70 dark:text-primary dark:hover:text-primary/70">
                            <span class="material-symbols-outlined text-sm">close</span>
                          </button>
                        </span>
                      }
                    </div>
                  </div>
                }
                
                @if (hasNoCategoriesSelected() && customCategories().length === 0) {
                  <span class="mt-1 text-sm text-red-500">Selecciona al menos una categoría o crea una nueva</span>
                }
              </div>

              <!-- Tamaño del Sistema -->
              <div class="md:col-span-2">
                <label class="mb-2 text-sm font-medium text-text-light dark:text-text-dark">¿Para cuántas personas es el sistema? <span class="text-red-500">*</span></label>
                <select
                  formControlName="systemUsers"
                  class="form-input h-12 w-full rounded-lg border border-border-light bg-background-light py-2 px-3 text-base text-text-light ring-primary/50 transition-all duration-200 focus:border-primary focus:outline-none focus:ring-2 dark:border-border-dark dark:bg-background-dark dark:text-text-dark dark:focus:border-primary"
                  [class.border-red-500]="setupForm.get('systemUsers')?.invalid && setupForm.get('systemUsers')?.touched">
                  <option value="1-5">1-5 usuarios</option>
                  <option value="6-10">6-10 usuarios</option>
                  <option value="11-20">11-20 usuarios</option>
                  <option value="21+">21+ usuarios</option>
                </select>
                @if (setupForm.get('systemUsers')?.invalid && setupForm.get('systemUsers')?.touched) {
                  <span class="mt-1 text-sm text-red-500">Selecciona el tamaño del sistema</span>
                }
              </div>
            </div>
            
            <!-- Personalización de Página -->
            <div class="mt-6 border-t border-border-light dark:border-border-dark pt-6">
              <h3 class="text-lg font-semibold text-text-light dark:text-text-dark mb-4">Personalización de la Página Principal</h3>
              <p class="text-xs text-gray-500 dark:text-gray-400 mb-4">Personaliza los textos e imágenes que verán tus clientes en la página de inicio</p>
              
              <div class="space-y-4">
                <div>
                  <label class="mb-2 text-sm font-medium text-text-light dark:text-text-dark">Título Principal</label>
                  <input
                    type="text"
                    formControlName="homeTitle"
                    placeholder="Ej: Bienvenido a nuestra tienda"
                    class="form-input h-12 w-full rounded-lg border border-border-light bg-background-light py-2 px-3 text-base text-text-light placeholder-placeholder-light ring-primary/50 transition-all duration-200 focus:border-primary focus:outline-none focus:ring-2 dark:border-border-dark dark:bg-background-dark dark:text-text-dark dark:placeholder-placeholder-dark dark:focus:border-primary">
                </div>
                
                <div>
                  <label class="mb-2 text-sm font-medium text-text-light dark:text-text-dark">Subtítulo</label>
                  <input
                    type="text"
                    formControlName="homeSubtitle"
                    placeholder="Ej: Los mejores productos al mejor precio"
                    class="form-input h-12 w-full rounded-lg border border-border-light bg-background-light py-2 px-3 text-base text-text-light placeholder-placeholder-light ring-primary/50 transition-all duration-200 focus:border-primary focus:outline-none focus:ring-2 dark:border-border-dark dark:bg-background-dark dark:text-text-dark dark:placeholder-placeholder-dark dark:focus:border-primary">
                </div>
                
                <div>
                  <label class="mb-2 text-sm font-medium text-text-light dark:text-text-dark">Descripción</label>
                  <textarea
                    formControlName="homeDescription"
                    rows="4"
                    placeholder="Describe tu negocio, tus valores, lo que te hace único..."
                    class="form-input w-full rounded-lg border border-border-light bg-background-light py-2 px-3 text-base text-text-light placeholder-placeholder-light ring-primary/50 transition-all duration-200 focus:border-primary focus:outline-none focus:ring-2 dark:border-border-dark dark:bg-background-dark dark:text-text-dark dark:placeholder-placeholder-dark dark:focus:border-primary"></textarea>
                </div>
                
                <div>
                  <label class="mb-2 text-sm font-medium text-text-light dark:text-text-dark">Imagen de Banner Principal</label>
                  <input
                    type="file"
                    accept="image/*"
                    (change)="onHomeBannerSelected($event)"
                    class="form-input h-12 w-full rounded-lg border border-border-light bg-background-light py-2 px-3 text-base text-text-light ring-primary/50 transition-all duration-200 focus:border-primary focus:outline-none focus:ring-2 dark:border-border-dark dark:bg-background-dark dark:text-text-dark dark:focus:border-primary">
                  <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">Recomendado: 1920x600px, máximo 5MB</p>
                  @if (setupForm.get('homeBannerImageUrl')?.value) {
                    <div class="mt-2">
                      <img [src]="setupForm.get('homeBannerImageUrl')?.value" alt="Banner preview" class="max-w-full h-32 object-cover rounded-lg border border-border-light dark:border-border-dark">
                    </div>
                  }
                </div>
              </div>
            </div>
          </div>
        }

        <!-- PASO 4: Información de Pago y Envío -->
        @if (currentStep() === 4) {
          <div class="space-y-6">
            <div>
              <h2 class="text-2xl font-bold text-text-light dark:text-text-dark mb-2">Información de Pago y Envío</h2>
              <p class="text-sm text-text-light/70 dark:text-text-dark/70">Configura los métodos de pago y opciones de entrega</p>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <!-- Sección: Métodos de Pago Digital -->
              <div class="md:col-span-2 border border-border-light dark:border-border-dark rounded-lg p-4">
                <h3 class="text-lg font-semibold text-text-light dark:text-text-dark mb-4">Métodos de Pago Digital</h3>
                
                <div class="space-y-4">
                  <!-- Yape/Plin Unificado -->
                  <div class="space-y-3">
                    <label class="text-sm font-medium text-text-light dark:text-text-dark">Yape/Plin</label>
                    <div>
                      <label class="mb-1 block text-xs text-gray-600 dark:text-gray-400">Número de teléfono</label>
                      <input
                        class="form-input h-10 w-full rounded-lg border border-border-light bg-background-light py-2 px-3 text-sm text-text-light placeholder-placeholder-light ring-primary/50 transition-all duration-200 focus:border-primary focus:outline-none focus:ring-2 dark:border-border-dark dark:bg-background-dark dark:text-text-dark dark:placeholder-placeholder-dark dark:focus:border-primary"
                        type="tel"
                        placeholder="999 888 777"
                        formControlName="yapePlinPhone">
                    </div>
                    <div>
                      <label class="mb-1 block text-xs text-gray-600 dark:text-gray-400">QR Code (imagen)</label>
                      <input
                        type="file"
                        accept="image/*"
                        (change)="onYapePlinQRSelected($event)"
                        class="form-input h-10 w-full rounded-lg border border-border-light bg-background-light py-2 px-3 text-sm text-text-light ring-primary/50 transition-all duration-200 focus:border-primary focus:outline-none focus:ring-2 dark:border-border-dark dark:bg-background-dark dark:text-text-dark dark:focus:border-primary">
                      <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">Sube la imagen de tu QR de Yape/Plin</p>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Sección: Cuenta Bancaria -->
              <div class="md:col-span-2 border border-border-light dark:border-border-dark rounded-lg p-4">
                <h3 class="text-lg font-semibold text-text-light dark:text-text-dark mb-4">Cuenta Bancaria (Opcional)</h3>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div>
                    <label class="mb-2 text-sm font-medium text-text-light dark:text-text-dark">Banco</label>
                    <input
                      class="form-input h-10 w-full rounded-lg border border-border-light bg-background-light py-2 px-3 text-sm text-text-light placeholder-placeholder-light ring-primary/50 transition-all duration-200 focus:border-primary focus:outline-none focus:ring-2 dark:border-border-dark dark:bg-background-dark dark:text-text-dark dark:placeholder-placeholder-dark dark:focus:border-primary"
                      type="text"
                      placeholder="Ej: BCP, BBVA, Interbank"
                      formControlName="bankName">
                  </div>

                  <div>
                    <label class="mb-2 text-sm font-medium text-text-light dark:text-text-dark">Tipo de Cuenta</label>
                    <select
                      formControlName="bankAccountType"
                      class="form-input h-10 w-full rounded-lg border border-border-light bg-background-light py-2 px-3 text-sm text-text-light ring-primary/50 transition-all duration-200 focus:border-primary focus:outline-none focus:ring-2 dark:border-border-dark dark:bg-background-dark dark:text-text-dark dark:focus:border-primary">
                      <option value="">Seleccione</option>
                      <option value="Ahorros">Ahorros</option>
                      <option value="Corriente">Corriente</option>
                    </select>
                  </div>

                  <div>
                    <label class="mb-2 text-sm font-medium text-text-light dark:text-text-dark">Número de Cuenta</label>
                    <input
                      class="form-input h-10 w-full rounded-lg border border-border-light bg-background-light py-2 px-3 text-sm text-text-light placeholder-placeholder-light ring-primary/50 transition-all duration-200 focus:border-primary focus:outline-none focus:ring-2 dark:border-border-dark dark:bg-background-dark dark:text-text-dark dark:placeholder-placeholder-dark dark:focus:border-primary"
                      type="text"
                      placeholder="1234567890123456"
                      formControlName="bankAccountNumber">
                  </div>

                  <div>
                    <label class="mb-2 text-sm font-medium text-text-light dark:text-text-dark">CCI (Opcional)</label>
                    <input
                      class="form-input h-10 w-full rounded-lg border border-border-light bg-background-light py-2 px-3 text-sm text-text-light placeholder-placeholder-light ring-primary/50 transition-all duration-200 focus:border-primary focus:outline-none focus:ring-2 dark:border-border-dark dark:bg-background-dark dark:text-text-dark dark:placeholder-placeholder-dark dark:focus:border-primary"
                      type="text"
                      placeholder="00000000000000000000"
                      formControlName="bankCCI">
                  </div>
                </div>
              </div>

              <!-- Sección: Opciones de Envío -->
              <div class="md:col-span-2 border border-border-light dark:border-border-dark rounded-lg p-4">
                <h3 class="text-lg font-semibold text-text-light dark:text-text-dark mb-4">Opciones de Entrega</h3>
                
                <div class="space-y-4">
                  @if (setupForm.get('isVirtual')?.value) {
                    <!-- Si es virtual, solo envío -->
                    <div>
                      <label class="mb-2 text-sm font-medium text-text-light dark:text-text-dark">Tipo de Entrega <span class="text-red-500">*</span></label>
                      <select
                        formControlName="deliveryType"
                        class="form-input h-10 w-full rounded-lg border border-border-light bg-background-light py-2 px-3 text-sm text-text-light ring-primary/50 transition-all duration-200 focus:border-primary focus:outline-none focus:ring-2 dark:border-border-dark dark:bg-background-dark dark:text-text-dark dark:focus:border-primary">
                        <option value="SoloEnvio">Solo envío a domicilio</option>
                      </select>
                      <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">Tu negocio es virtual, solo está disponible envío a domicilio</p>
                    </div>
                  } @else {
                    <!-- Si tiene ubicación física, puede elegir -->
                    <div>
                      <label class="mb-2 text-sm font-medium text-text-light dark:text-text-dark">Tipo de Entrega <span class="text-red-500">*</span></label>
                      <select
                        formControlName="deliveryType"
                        class="form-input h-10 w-full rounded-lg border border-border-light bg-background-light py-2 px-3 text-sm text-text-light ring-primary/50 transition-all duration-200 focus:border-primary focus:outline-none focus:ring-2 dark:border-border-dark dark:bg-background-dark dark:text-text-dark dark:focus:border-primary">
                        <option value="Ambos">Ambos (Recogida en tienda y envío a domicilio)</option>
                        <option value="SoloRecogida">Solo recogida en tienda</option>
                        <option value="SoloEnvio">Solo envío a domicilio</option>
                      </select>
                      <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">Esta configuración afectará las opciones disponibles en el carrito de compras</p>
                    </div>
                  }

                  @if (setupForm.get('deliveryType')?.value !== 'SoloRecogida') {
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                      <div>
                        <label class="mb-2 text-sm font-medium text-text-light dark:text-text-dark">Costo de Envío (S/)</label>
                        <input
                          class="form-input h-10 w-full rounded-lg border border-border-light bg-background-light py-2 px-3 text-sm text-text-light placeholder-placeholder-light ring-primary/50 transition-all duration-200 focus:border-primary focus:outline-none focus:ring-2 dark:border-border-dark dark:bg-background-dark dark:text-text-dark dark:placeholder-placeholder-dark dark:focus:border-primary"
                          type="number"
                          step="0.01"
                          min="0"
                          placeholder="0.00"
                          formControlName="deliveryCost">
                        <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">Deja en 0 para envío gratis</p>
                      </div>

                      <div>
                        <label class="mb-2 text-sm font-medium text-text-light dark:text-text-dark">Zonas de Envío</label>
                        <input
                          class="form-input h-10 w-full rounded-lg border border-border-light bg-background-light py-2 px-3 text-sm text-text-light placeholder-placeholder-light ring-primary/50 transition-all duration-200 focus:border-primary focus:outline-none focus:ring-2 dark:border-border-dark dark:bg-background-dark dark:text-text-dark dark:placeholder-placeholder-dark dark:focus:border-primary"
                          type="text"
                          placeholder="Ej: Lima, Callao, San Isidro"
                          formControlName="deliveryZones">
                        <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">Separa las zonas con comas</p>
                      </div>
                    </div>
                  }
                </div>
              </div>
            </div>
          </div>
        }

        <!-- PASO 5: Crear Usuarios -->
        @if (currentStep() === 5) {
          <div class="space-y-6">
            <div>
              <h2 class="text-2xl font-bold text-text-light dark:text-text-dark mb-2">Crear Usuario Cajero</h2>
              <p class="text-sm text-text-light/70 dark:text-text-dark/70">Crea una cuenta de cajero con acceso al POS</p>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <!-- ¿Crear Cajero? -->
              <div class="md:col-span-2">
                <label class="flex items-center gap-3 cursor-pointer">
                  <input
                    type="checkbox"
                    formControlName="createCashier"
                    class="h-5 w-5 rounded border-border-light text-primary focus:ring-2 focus:ring-primary/50 dark:border-border-dark accent-primary">
                  <span class="text-sm font-medium text-text-light dark:text-text-dark">Crear cuenta de cajero ahora</span>
                </label>
                <p class="text-xs text-gray-500 dark:text-gray-400 mt-1 ml-8">Puedes crear más usuarios después desde el panel de administración</p>
              </div>

              <!-- Formulario de Cajero (si se crea) -->
              @if (setupForm.get('createCashier')?.value) {
                <div class="md:col-span-2 border-t border-border-light dark:border-border-dark pt-4 mt-4">
                  <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                      <label class="mb-2 text-sm font-medium text-text-light dark:text-text-dark">Nombre <span class="text-red-500">*</span></label>
                      <input
                        class="form-input h-12 w-full rounded-lg border border-border-light bg-background-light py-2 px-3 text-base text-text-light placeholder-placeholder-light ring-primary/50 transition-all duration-200 focus:border-primary focus:outline-none focus:ring-2 dark:border-border-dark dark:bg-background-dark dark:text-text-dark dark:placeholder-placeholder-dark dark:focus:border-primary"
                        type="text"
                        placeholder="Juan"
                        formControlName="cashierFirstName"
                        [class.border-red-500]="setupForm.get('cashierFirstName')?.invalid && setupForm.get('cashierFirstName')?.touched">
                      @if (setupForm.get('cashierFirstName')?.invalid && setupForm.get('cashierFirstName')?.touched) {
                        <span class="mt-1 text-sm text-red-500">El nombre es requerido</span>
                      }
                    </div>

                    <div>
                      <label class="mb-2 text-sm font-medium text-text-light dark:text-text-dark">Apellido <span class="text-red-500">*</span></label>
                      <input
                        class="form-input h-12 w-full rounded-lg border border-border-light bg-background-light py-2 px-3 text-base text-text-light placeholder-placeholder-light ring-primary/50 transition-all duration-200 focus:border-primary focus:outline-none focus:ring-2 dark:border-border-dark dark:bg-background-dark dark:text-text-dark dark:placeholder-placeholder-dark dark:focus:border-primary"
                        type="text"
                        placeholder="Pérez"
                        formControlName="cashierLastName"
                        [class.border-red-500]="setupForm.get('cashierLastName')?.invalid && setupForm.get('cashierLastName')?.touched">
                      @if (setupForm.get('cashierLastName')?.invalid && setupForm.get('cashierLastName')?.touched) {
                        <span class="mt-1 text-sm text-red-500">El apellido es requerido</span>
                      }
                    </div>

                    <div>
                      <label class="mb-2 text-sm font-medium text-text-light dark:text-text-dark">DNI <span class="text-red-500">*</span></label>
                      <input
                        class="form-input h-12 w-full rounded-lg border border-border-light bg-background-light py-2 px-3 text-base text-text-light placeholder-placeholder-light ring-primary/50 transition-all duration-200 focus:border-primary focus:outline-none focus:ring-2 dark:border-border-dark dark:bg-background-dark dark:text-text-dark dark:placeholder-placeholder-dark dark:focus:border-primary"
                        type="text"
                        placeholder="12345678"
                        maxlength="8"
                        formControlName="cashierDni"
                        [class.border-red-500]="setupForm.get('cashierDni')?.invalid && setupForm.get('cashierDni')?.touched">
                      @if (setupForm.get('cashierDni')?.invalid && setupForm.get('cashierDni')?.touched) {
                        <span class="mt-1 text-sm text-red-500">El DNI debe tener 8 dígitos</span>
                      }
                    </div>

                    <div>
                      <label class="mb-2 text-sm font-medium text-text-light dark:text-text-dark">Email <span class="text-red-500">*</span></label>
                      <input
                        class="form-input h-12 w-full rounded-lg border border-border-light bg-background-light py-2 px-3 text-base text-text-light placeholder-placeholder-light ring-primary/50 transition-all duration-200 focus:border-primary focus:outline-none focus:ring-2 dark:border-border-dark dark:bg-background-dark dark:text-text-dark dark:placeholder-placeholder-dark dark:focus:border-primary"
                        type="email"
                        placeholder="cajero@empresa.com"
                        formControlName="cashierEmail"
                        [class.border-red-500]="setupForm.get('cashierEmail')?.invalid && setupForm.get('cashierEmail')?.touched">
                      @if (setupForm.get('cashierEmail')?.invalid && setupForm.get('cashierEmail')?.touched) {
                        <span class="mt-1 text-sm text-red-500">El email es requerido y debe ser válido</span>
                      }
                    </div>

                    <div class="md:col-span-2">
                      <label class="mb-2 text-sm font-medium text-text-light dark:text-text-dark">Contraseña <span class="text-red-500">*</span></label>
                      <input
                        class="form-input h-12 w-full rounded-lg border border-border-light bg-background-light py-2 px-3 text-base text-text-light placeholder-placeholder-light ring-primary/50 transition-all duration-200 focus:border-primary focus:outline-none focus:ring-2 dark:border-border-dark dark:bg-background-dark dark:text-text-dark dark:placeholder-placeholder-dark dark:focus:border-primary"
                        type="password"
                        placeholder="Mínimo 6 caracteres"
                        formControlName="cashierPassword"
                        [class.border-red-500]="setupForm.get('cashierPassword')?.invalid && setupForm.get('cashierPassword')?.touched">
                      @if (setupForm.get('cashierPassword')?.invalid && setupForm.get('cashierPassword')?.touched) {
                        <span class="mt-1 text-sm text-red-500">La contraseña debe tener al menos 6 caracteres</span>
                      }
                    </div>
                  </div>
                </div>
              }
            </div>
          </div>
        }

        <!-- Mensaje de Error -->
        @if (errorMessage()) {
          <div class="rounded-lg bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 p-3 mt-4">
            <p class="text-sm text-red-600 dark:text-red-400">{{ errorMessage() }}</p>
          </div>
        }

        <!-- Botones de Navegación -->
        <div class="flex justify-between items-center mt-8 pt-6 border-t border-border-light dark:border-border-dark">
          <div class="flex gap-3">
            @if (currentStep() > 1) {
              <button
                type="button"
                (click)="previousStep()"
                class="flex h-12 min-w-[120px] cursor-pointer items-center justify-center overflow-hidden rounded-lg border-2 border-border-light bg-background-light px-5 text-base font-bold leading-normal text-text-light transition-colors duration-200 hover:bg-primary/10 focus:outline-none focus:ring-2 focus:ring-primary/50 dark:border-border-dark dark:bg-background-dark dark:text-text-dark">
                <span class="material-symbols-outlined mr-2">arrow_back</span>
                <span>Anterior</span>
              </button>
            }
            <button
              type="button"
              (click)="attemptExit()"
              class="flex h-12 min-w-[120px] cursor-pointer items-center justify-center overflow-hidden rounded-lg border-2 border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 px-5 text-base font-bold leading-normal text-gray-700 dark:text-gray-300 transition-colors duration-200 hover:bg-gray-100 dark:hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-gray-500/50">
              <span class="material-symbols-outlined mr-2">close</span>
              <span>Salir</span>
            </button>
          </div>

          @if (currentStep() < steps.length) {
            <button
              type="button"
              (click)="nextStep()"
              [disabled]="!validateCurrentStep()"
              class="flex h-12 min-w-[120px] cursor-pointer items-center justify-center overflow-hidden rounded-lg bg-primary px-5 text-base font-bold leading-normal text-white transition-colors duration-200 hover:bg-primary/90 focus:outline-none focus:ring-2 focus:ring-primary/50 focus:ring-offset-2 disabled:opacity-50 disabled:cursor-not-allowed">
              <span>Siguiente</span>
              <span class="material-symbols-outlined ml-2">arrow_forward</span>
            </button>
          } @else {
            <button
              type="submit"
              [disabled]="setupForm.invalid || isLoading()"
              class="flex h-12 min-w-[120px] cursor-pointer items-center justify-center overflow-hidden rounded-lg bg-primary px-5 text-base font-bold leading-normal text-white transition-colors duration-200 hover:bg-primary/90 focus:outline-none focus:ring-2 focus:ring-primary/50 focus:ring-offset-2 disabled:opacity-50 disabled:cursor-not-allowed">
              @if (isLoading()) {
                <span class="material-symbols-outlined animate-spin mr-2">refresh</span>
              }
              <span>Finalizar Configuración</span>
            </button>
          }
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Modal de Advertencia al Salir -->
@if (showExitWarning()) {
  <app-confirm-dialog
    [isOpen]="true"
    title="¿Salir sin completar la configuración?"
    message="Aún no has terminado de personalizar tu tienda. Si sales ahora, podrás continuar más tarde, pero es recomendable completar la configuración para tener tu tienda lista."
    confirmText="Seguir Configurando"
    cancelText="Omitir por Ahora"
    (confirmed)="onExitWarningConfirmed()"
    (cancelled)="onExitWarningCancelled()">
  </app-confirm-dialog>
}

