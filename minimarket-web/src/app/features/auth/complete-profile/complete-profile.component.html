<div class="relative flex min-h-screen w-full flex-col items-center justify-center bg-background-light dark:bg-background-dark group/design-root overflow-x-hidden" style='font-family: Inter, "Noto Sans", sans-serif;' [@fadeSlide]>
  <div class="w-full max-w-md p-6">
    <div class="flex flex-col items-center rounded-xl border border-border-light/50 bg-card-light p-8 shadow-sm dark:border-border-dark/50 dark:bg-card-dark">
      <!-- Logo and Title -->
      <div class="mb-6 flex flex-col items-center">
        <div class="mb-4">
          <svg class="h-14 w-14 text-primary" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewbox="0 0 24 24">
            <path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"></path>
            <line x1="3" x2="21" y1="6" y2="6"></line>
            <path d="M16 10a4 4 0 0 1-8 0"></path>
          </svg>
        </div>
        <h1 class="text-2xl font-bold tracking-tight text-text-light dark:text-text-dark">¡Te damos la bienvenida {{ userName() }}!</h1>
        <p class="mt-1 text-base text-text-light/70 dark:text-text-dark/70">Ingresa los datos restantes y comenzarás a disfrutar de nuestros beneficios.</p>
      </div>

      <!-- Form -->
      <form [formGroup]="completeProfileForm" (ngSubmit)="onSubmit()" class="w-full">
        <div class="flex w-full flex-col gap-4">
          <!-- First Name Field -->
          <div class="flex w-full flex-col">
            <label class="mb-2 text-sm font-medium text-text-light dark:text-text-dark" for="firstName">Nombre <span class="text-red-500">*</span></label>
            <div class="relative flex w-full items-center">
              <span class="material-symbols-outlined pointer-events-none absolute left-3 text-xl text-placeholder-light dark:text-placeholder-dark">badge</span>
              <input
                class="form-input h-12 w-full min-w-0 flex-1 rounded-lg border border-border-light bg-background-light py-2 pl-10 pr-3 text-base text-text-light placeholder-placeholder-light ring-primary/50 transition-all duration-200 focus:border-primary focus:outline-none focus:ring-2 dark:border-border-dark dark:bg-background-dark dark:text-text-dark dark:placeholder-placeholder-dark dark:focus:border-primary"
                id="firstName"
                type="text"
                placeholder="Juan"
                formControlName="firstName"
                [class.border-red-500]="completeProfileForm.get('firstName')?.invalid && completeProfileForm.get('firstName')?.touched">
            </div>
            @if (completeProfileForm.get('firstName')?.invalid && completeProfileForm.get('firstName')?.touched) {
              <span class="mt-1 text-sm text-red-500">El nombre es requerido</span>
            }
          </div>

          <!-- Last Name Field -->
          <div class="flex w-full flex-col">
            <label class="mb-2 text-sm font-medium text-text-light dark:text-text-dark" for="lastName">Apellido <span class="text-red-500">*</span></label>
            <div class="relative flex w-full items-center">
              <span class="material-symbols-outlined pointer-events-none absolute left-3 text-xl text-placeholder-light dark:text-placeholder-dark">badge</span>
              <input
                class="form-input h-12 w-full min-w-0 flex-1 rounded-lg border border-border-light bg-background-light py-2 pl-10 pr-3 text-base text-text-light placeholder-placeholder-light ring-primary/50 transition-all duration-200 focus:border-primary focus:outline-none focus:ring-2 dark:border-border-dark dark:bg-background-dark dark:text-text-dark dark:placeholder-placeholder-dark dark:focus:border-primary"
                id="lastName"
                type="text"
                placeholder="Pérez"
                formControlName="lastName"
                [class.border-red-500]="completeProfileForm.get('lastName')?.invalid && completeProfileForm.get('lastName')?.touched">
            </div>
            @if (completeProfileForm.get('lastName')?.invalid && completeProfileForm.get('lastName')?.touched) {
              <span class="mt-1 text-sm text-red-500">El apellido es requerido</span>
            }
          </div>

          <!-- DNI Field -->
          <div class="flex w-full flex-col">
            <label class="mb-2 text-sm font-medium text-text-light dark:text-text-dark" for="dni">DNI <span class="text-red-500">*</span></label>
            <div class="relative flex w-full items-center">
              <span class="material-symbols-outlined pointer-events-none absolute left-3 text-xl text-placeholder-light dark:text-placeholder-dark">credit_card</span>
              <input
                class="form-input h-12 w-full min-w-0 flex-1 rounded-lg border border-border-light bg-background-light py-2 pl-10 pr-3 text-base text-text-light placeholder-placeholder-light ring-primary/50 transition-all duration-200 focus:border-primary focus:outline-none focus:ring-2 dark:border-border-dark dark:bg-background-dark dark:text-text-dark dark:placeholder-placeholder-dark dark:focus:border-primary"
                id="dni"
                type="text"
                placeholder="12345678"
                formControlName="dni"
                maxlength="8"
                [class.border-red-500]="completeProfileForm.get('dni')?.invalid && completeProfileForm.get('dni')?.touched">
            </div>
            @if (completeProfileForm.get('dni')?.invalid && completeProfileForm.get('dni')?.touched) {
              <span class="mt-1 text-sm text-red-500">
                @if (completeProfileForm.get('dni')?.errors?.['required']) {
                  El DNI es requerido
                } @else if (completeProfileForm.get('dni')?.errors?.['pattern']) {
                  El DNI debe tener exactamente 8 dígitos
                }
              </span>
            }
          </div>

          <!-- Phone Field -->
          <div class="flex w-full flex-col">
            <label class="mb-2 text-sm font-medium text-text-light dark:text-text-dark" for="phone">Teléfono <span class="text-red-500">*</span></label>
            <div class="relative flex w-full items-center">
              <span class="material-symbols-outlined pointer-events-none absolute left-3 text-xl text-placeholder-light dark:text-placeholder-dark">phone</span>
              <input
                class="form-input h-12 w-full min-w-0 flex-1 rounded-lg border border-border-light bg-background-light py-2 pl-10 pr-3 text-base text-text-light placeholder-placeholder-light ring-primary/50 transition-all duration-200 focus:border-primary focus:outline-none focus:ring-2 dark:border-border-dark dark:bg-background-dark dark:text-text-dark dark:placeholder-placeholder-dark dark:focus:border-primary"
                id="phone"
                type="tel"
                placeholder="+51 999 999 999"
                formControlName="phone"
                [class.border-red-500]="completeProfileForm.get('phone')?.invalid && completeProfileForm.get('phone')?.touched">
            </div>
            @if (completeProfileForm.get('phone')?.invalid && completeProfileForm.get('phone')?.touched) {
              <span class="mt-1 text-sm text-red-500">
                @if (completeProfileForm.get('phone')?.errors?.['required']) {
                  El teléfono es requerido
                } @else if (completeProfileForm.get('phone')?.errors?.['pattern']) {
                  Ingresa un teléfono válido
                }
              </span>
            }
          </div>

          <!-- Método de Pago Opcional -->
          <div class="flex w-full flex-col gap-4 pt-2 border-t border-border-light dark:border-border-dark">
            <label class="flex items-center gap-2 cursor-pointer">
              <input 
                type="checkbox"
                [checked]="includePaymentMethod()"
                (change)="togglePaymentMethod()"
                class="w-4 h-4 text-primary border-gray-300 rounded focus:ring-primary">
              <span class="text-sm font-medium text-text-light dark:text-text-dark">Agregar método de pago (opcional)</span>
            </label>

            @if (includePaymentMethod()) {
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4 pl-6">
                <div class="md:col-span-2">
                  <label class="mb-2 text-sm font-medium text-text-light dark:text-text-dark" for="cardHolderName">Nombre del Titular <span class="text-red-500">*</span></label>
                  <input
                    class="form-input h-12 w-full min-w-0 flex-1 rounded-lg border border-border-light bg-background-light py-2 px-3 text-base text-text-light placeholder-placeholder-light ring-primary/50 transition-all duration-200 focus:border-primary focus:outline-none focus:ring-2 dark:border-border-dark dark:bg-background-dark dark:text-text-dark dark:placeholder-placeholder-dark dark:focus:border-primary"
                    id="cardHolderName"
                    type="text"
                    placeholder="Juan Pérez"
                    formControlName="cardHolderName"
                    [class.border-red-500]="completeProfileForm.get('cardHolderName')?.invalid && completeProfileForm.get('cardHolderName')?.touched">
                  @if (completeProfileForm.get('cardHolderName')?.invalid && completeProfileForm.get('cardHolderName')?.touched) {
                    <span class="mt-1 text-sm text-red-500">El nombre del titular es requerido</span>
                  }
                </div>

                <div class="md:col-span-2">
                  <label class="mb-2 text-sm font-medium text-text-light dark:text-text-dark" for="cardNumber">Número de Tarjeta <span class="text-red-500">*</span></label>
                  <input
                    class="form-input h-12 w-full min-w-0 flex-1 rounded-lg border border-border-light bg-background-light py-2 px-3 text-base text-text-light placeholder-placeholder-light ring-primary/50 transition-all duration-200 focus:border-primary focus:outline-none focus:ring-2 dark:border-border-dark dark:bg-background-dark dark:text-text-dark dark:placeholder-placeholder-dark dark:focus:border-primary"
                    id="cardNumber"
                    type="text"
                    placeholder="1234 5678 9012 3456"
                    formControlName="cardNumber"
                    maxlength="19"
                    [class.border-red-500]="completeProfileForm.get('cardNumber')?.invalid && completeProfileForm.get('cardNumber')?.touched">
                  @if (completeProfileForm.get('cardNumber')?.invalid && completeProfileForm.get('cardNumber')?.touched) {
                    <span class="mt-1 text-sm text-red-500">El número de tarjeta debe tener entre 13 y 19 dígitos</span>
                  }
                </div>

                <div>
                  <label class="mb-2 text-sm font-medium text-text-light dark:text-text-dark" for="expiryMonth">Mes de Expiración</label>
                  <select
                    class="form-input h-12 w-full min-w-0 flex-1 rounded-lg border border-border-light bg-background-light py-2 px-3 text-base text-text-light ring-primary/50 transition-all duration-200 focus:border-primary focus:outline-none focus:ring-2 dark:border-border-dark dark:bg-background-dark dark:text-text-dark dark:focus:border-primary"
                    id="expiryMonth"
                    formControlName="expiryMonth">
                    @for (month of [1,2,3,4,5,6,7,8,9,10,11,12]; track month) {
                      <option [value]="month">{{ formatMonth(month) }}</option>
                    }
                  </select>
                </div>

                <div>
                  <label class="mb-2 text-sm font-medium text-text-light dark:text-text-dark" for="expiryYear">Año de Expiración</label>
                  <select
                    class="form-input h-12 w-full min-w-0 flex-1 rounded-lg border border-border-light bg-background-light py-2 px-3 text-base text-text-light ring-primary/50 transition-all duration-200 focus:border-primary focus:outline-none focus:ring-2 dark:border-border-dark dark:bg-background-dark dark:text-text-dark dark:focus:border-primary"
                    id="expiryYear"
                    formControlName="expiryYear">
                    @for (year of getYears(); track year) {
                      <option [value]="year">{{ year }}</option>
                    }
                  </select>
                </div>
              </div>
            }
          </div>

          <!-- Dirección de Envío Opcional -->
          <div class="flex w-full flex-col gap-4 pt-2 border-t border-border-light dark:border-border-dark">
            <label class="flex items-center gap-2 cursor-pointer">
              <input 
                type="checkbox"
                [checked]="includeAddress()"
                (change)="toggleAddress()"
                class="w-4 h-4 text-primary border-gray-300 rounded focus:ring-primary">
              <span class="text-sm font-medium text-text-light dark:text-text-dark">Agregar dirección de envío (opcional)</span>
            </label>

            @if (includeAddress()) {
              <div class="pl-6 flex flex-col gap-4">
                <!-- Selector de direcciones existentes -->
                @if (existingAddresses().length > 0 && !showNewAddressForm()) {
                  <div class="flex flex-col gap-3">
                    <p class="text-sm font-medium text-text-light dark:text-text-dark">Selecciona una dirección existente:</p>
                    <div class="grid grid-cols-1 gap-3">
                      @for (address of existingAddresses(); track address.id) {
                        <label 
                          class="flex items-start gap-3 p-4 border-2 rounded-lg cursor-pointer transition-all hover:bg-primary/5"
                          [class.border-primary]="selectedAddressId() === address.id"
                          [class.border-gray-300]="selectedAddressId() !== address.id"
                          [class.dark:border-gray-600]="selectedAddressId() !== address.id"
                          [class.dark:border-primary]="selectedAddressId() === address.id">
                          <input 
                            type="radio"
                            [value]="address.id"
                            [checked]="selectedAddressId() === address.id"
                            (change)="selectExistingAddress(address.id)"
                            class="mt-1 w-4 h-4 text-primary border-gray-300 focus:ring-primary">
                          <div class="flex-1">
                            <div class="flex items-center gap-2 mb-1">
                              <span class="font-semibold text-text-light dark:text-text-dark">{{ address.label }}</span>
                              @if (address.isDefault) {
                                <span class="text-xs px-2 py-0.5 bg-primary/20 text-primary rounded-full">Predeterminada</span>
                              }
                            </div>
                            <p class="text-sm text-gray-600 dark:text-gray-400 mb-1"><strong>Destinatario:</strong> {{ address.fullName }}</p>
                            <p class="text-sm text-gray-600 dark:text-gray-400 mb-1"><strong>Teléfono:</strong> {{ address.phone }}</p>
                            <p class="text-sm text-text-light dark:text-text-dark mb-1">{{ address.address }}</p>
                            @if (address.reference) {
                              <p class="text-sm text-gray-600 dark:text-gray-400 mb-1"><strong>Referencia:</strong> {{ address.reference }}</p>
                            }
                            <p class="text-sm text-gray-600 dark:text-gray-400">{{ address.district }}, {{ address.city }}, {{ address.region }}</p>
                          </div>
                        </label>
                      }
                    </div>
                    <button 
                      type="button"
                      (click)="showNewAddress()"
                      class="flex items-center gap-2 px-4 py-2 border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-lg text-text-light dark:text-text-dark hover:border-primary hover:bg-primary/5 transition-colors">
                      <span class="material-symbols-outlined text-lg">add</span>
                      <span>Agregar nueva dirección</span>
                    </button>
                  </div>
                }

                <!-- Formulario para nueva dirección -->
                @if (showNewAddressForm() || existingAddresses().length === 0) {
                  <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label class="mb-2 text-sm font-medium text-text-light dark:text-text-dark" for="addressLabel">Etiqueta <span class="text-red-500">*</span></label>
                  <input
                    class="form-input h-12 w-full min-w-0 flex-1 rounded-lg border border-border-light bg-background-light py-2 px-3 text-base text-text-light placeholder-placeholder-light ring-primary/50 transition-all duration-200 focus:border-primary focus:outline-none focus:ring-2 dark:border-border-dark dark:bg-background-dark dark:text-text-dark dark:placeholder-placeholder-dark dark:focus:border-primary"
                    id="addressLabel"
                    type="text"
                    placeholder="Casa, Trabajo..."
                    formControlName="addressLabel"
                    [class.border-red-500]="completeProfileForm.get('addressLabel')?.invalid && completeProfileForm.get('addressLabel')?.touched">
                  @if (completeProfileForm.get('addressLabel')?.invalid && completeProfileForm.get('addressLabel')?.touched) {
                    <span class="mt-1 text-sm text-red-500">La etiqueta es requerida</span>
                  }
                </div>

                <div>
                  <label class="mb-2 text-sm font-medium text-text-light dark:text-text-dark" for="addressFullName">Nombre Completo <span class="text-red-500">*</span></label>
                  <input
                    class="form-input h-12 w-full min-w-0 flex-1 rounded-lg border border-border-light bg-background-light py-2 px-3 text-base text-text-light placeholder-placeholder-light ring-primary/50 transition-all duration-200 focus:border-primary focus:outline-none focus:ring-2 dark:border-border-dark dark:bg-background-dark dark:text-text-dark dark:placeholder-placeholder-dark dark:focus:border-primary"
                    id="addressFullName"
                    type="text"
                    placeholder="Juan Pérez"
                    formControlName="addressFullName"
                    [class.border-red-500]="completeProfileForm.get('addressFullName')?.invalid && completeProfileForm.get('addressFullName')?.touched">
                  @if (completeProfileForm.get('addressFullName')?.invalid && completeProfileForm.get('addressFullName')?.touched) {
                    <span class="mt-1 text-sm text-red-500">El nombre completo es requerido</span>
                  }
                </div>

                <div>
                  <label class="mb-2 text-sm font-medium text-text-light dark:text-text-dark" for="addressPhone">Teléfono <span class="text-red-500">*</span></label>
                  <input
                    class="form-input h-12 w-full min-w-0 flex-1 rounded-lg border border-border-light bg-background-light py-2 px-3 text-base text-text-light placeholder-placeholder-light ring-primary/50 transition-all duration-200 focus:border-primary focus:outline-none focus:ring-2 dark:border-border-dark dark:bg-background-dark dark:text-text-dark dark:placeholder-placeholder-dark dark:focus:border-primary"
                    id="addressPhone"
                    type="tel"
                    placeholder="+51 999 999 999"
                    formControlName="addressPhone"
                    [class.border-red-500]="completeProfileForm.get('addressPhone')?.invalid && completeProfileForm.get('addressPhone')?.touched">
                  @if (completeProfileForm.get('addressPhone')?.invalid && completeProfileForm.get('addressPhone')?.touched) {
                    <span class="mt-1 text-sm text-red-500">El teléfono es requerido</span>
                  }
                </div>

                <div>
                  <label class="mb-2 text-sm font-medium text-text-light dark:text-text-dark" for="addressDistrict">Distrito <span class="text-red-500">*</span></label>
                  <input
                    class="form-input h-12 w-full min-w-0 flex-1 rounded-lg border border-border-light bg-background-light py-2 px-3 text-base text-text-light placeholder-placeholder-light ring-primary/50 transition-all duration-200 focus:border-primary focus:outline-none focus:ring-2 dark:border-border-dark dark:bg-background-dark dark:text-text-dark dark:placeholder-placeholder-dark dark:focus:border-primary"
                    id="addressDistrict"
                    type="text"
                    placeholder="San Isidro"
                    formControlName="addressDistrict"
                    [class.border-red-500]="completeProfileForm.get('addressDistrict')?.invalid && completeProfileForm.get('addressDistrict')?.touched">
                  @if (completeProfileForm.get('addressDistrict')?.invalid && completeProfileForm.get('addressDistrict')?.touched) {
                    <span class="mt-1 text-sm text-red-500">El distrito es requerido</span>
                  }
                </div>

                <div>
                  <label class="mb-2 text-sm font-medium text-text-light dark:text-text-dark" for="addressCity">Ciudad <span class="text-red-500">*</span></label>
                  <input
                    class="form-input h-12 w-full min-w-0 flex-1 rounded-lg border border-border-light bg-background-light py-2 px-3 text-base text-text-light placeholder-placeholder-light ring-primary/50 transition-all duration-200 focus:border-primary focus:outline-none focus:ring-2 dark:border-border-dark dark:bg-background-dark dark:text-text-dark dark:placeholder-placeholder-dark dark:focus:border-primary"
                    id="addressCity"
                    type="text"
                    placeholder="Lima"
                    formControlName="addressCity"
                    [class.border-red-500]="completeProfileForm.get('addressCity')?.invalid && completeProfileForm.get('addressCity')?.touched">
                  @if (completeProfileForm.get('addressCity')?.invalid && completeProfileForm.get('addressCity')?.touched) {
                    <span class="mt-1 text-sm text-red-500">La ciudad es requerida</span>
                  }
                </div>

                <div>
                  <label class="mb-2 text-sm font-medium text-text-light dark:text-text-dark" for="addressRegion">Región/Departamento <span class="text-red-500">*</span></label>
                  <input
                    class="form-input h-12 w-full min-w-0 flex-1 rounded-lg border border-border-light bg-background-light py-2 px-3 text-base text-text-light placeholder-placeholder-light ring-primary/50 transition-all duration-200 focus:border-primary focus:outline-none focus:ring-2 dark:border-border-dark dark:bg-background-dark dark:text-text-dark dark:placeholder-placeholder-dark dark:focus:border-primary"
                    id="addressRegion"
                    type="text"
                    placeholder="Lima"
                    formControlName="addressRegion"
                    [class.border-red-500]="completeProfileForm.get('addressRegion')?.invalid && completeProfileForm.get('addressRegion')?.touched">
                  @if (completeProfileForm.get('addressRegion')?.invalid && completeProfileForm.get('addressRegion')?.touched) {
                    <span class="mt-1 text-sm text-red-500">La región es requerida</span>
                  }
                </div>

                <div class="md:col-span-2">
                  <label class="mb-2 text-sm font-medium text-text-light dark:text-text-dark" for="addressAddress">Dirección Completa <span class="text-red-500">*</span></label>
                  <textarea
                    class="form-input w-full min-w-0 flex-1 rounded-lg border border-border-light bg-background-light py-2 px-3 text-base text-text-light placeholder-placeholder-light ring-primary/50 transition-all duration-200 focus:border-primary focus:outline-none focus:ring-2 dark:border-border-dark dark:bg-background-dark dark:text-text-dark dark:placeholder-placeholder-dark dark:focus:border-primary"
                    id="addressAddress"
                    rows="3"
                    placeholder="Av. Principal 123"
                    formControlName="addressAddress"
                    [class.border-red-500]="completeProfileForm.get('addressAddress')?.invalid && completeProfileForm.get('addressAddress')?.touched"></textarea>
                  @if (completeProfileForm.get('addressAddress')?.invalid && completeProfileForm.get('addressAddress')?.touched) {
                    <span class="mt-1 text-sm text-red-500">La dirección es requerida</span>
                  }
                </div>

                <div class="md:col-span-2">
                  <label class="mb-2 text-sm font-medium text-text-light dark:text-text-dark" for="addressReference">Referencia (opcional)</label>
                  <textarea
                    class="form-input w-full min-w-0 flex-1 rounded-lg border border-border-light bg-background-light py-2 px-3 text-base text-text-light placeholder-placeholder-light ring-primary/50 transition-all duration-200 focus:border-primary focus:outline-none focus:ring-2 dark:border-border-dark dark:bg-background-dark dark:text-text-dark dark:placeholder-placeholder-dark dark:focus:border-primary"
                    id="addressReference"
                    rows="2"
                    placeholder="Ej: Al lado del banco, portón verde..."
                    formControlName="addressReference"></textarea>
                </div>

                <div>
                  <label class="mb-2 text-sm font-medium text-text-light dark:text-text-dark" for="addressPostalCode">Código Postal (opcional)</label>
                  <input
                    class="form-input h-12 w-full min-w-0 flex-1 rounded-lg border border-border-light bg-background-light py-2 px-3 text-base text-text-light placeholder-placeholder-light ring-primary/50 transition-all duration-200 focus:border-primary focus:outline-none focus:ring-2 dark:border-border-dark dark:bg-background-dark dark:text-text-dark dark:placeholder-placeholder-dark dark:focus:border-primary"
                    id="addressPostalCode"
                    type="text"
                    placeholder="15001"
                    formControlName="addressPostalCode">
                </div>
                  </div>
                }
              </div>
            }
          </div>

          <!-- Error Message -->
          @if (errorMessage()) {
            <div class="rounded-lg bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 p-3">
              <p class="text-sm text-red-600 dark:text-red-400">{{ errorMessage() }}</p>
            </div>
          }

          <!-- Submit Button -->
          <div class="pt-4">
            <button
              type="submit"
              [disabled]="completeProfileForm.invalid || isLoading()"
              class="flex h-12 w-full min-w-[84px] cursor-pointer items-center justify-center overflow-hidden rounded-lg bg-primary px-5 text-base font-bold leading-normal text-white transition-colors duration-200 hover:bg-primary/90 focus:outline-none focus:ring-2 focus:ring-primary/50 focus:ring-offset-2 dark:focus:ring-offset-background-dark disabled:opacity-50 disabled:cursor-not-allowed">
              @if (isLoading()) {
                <span class="material-symbols-outlined animate-spin mr-2">refresh</span>
              }
              <span class="truncate">Crear cuenta</span>
            </button>
          </div>
        </div>
      </form>
    </div>
  </div>
</div>

