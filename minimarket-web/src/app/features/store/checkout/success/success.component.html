<div class="relative flex h-auto min-h-screen w-full flex-col">
  <!-- Header -->
  <app-store-header></app-store-header>

  <!-- Main Content -->
  <main class="flex-1 w-full">
    <div class="mx-auto max-w-4xl px-4 py-8 lg:py-16">
      <!-- Receiving Payment State -->
      @if (isReceiving()) {
        <div class="text-center py-16 fade-in">
          <div class="inline-flex items-center justify-center w-24 h-24 mb-6">
            <div class="spinner-container">
              <div class="spinner"></div>
            </div>
          </div>
          <h2 class="text-2xl lg:text-3xl font-bold text-gray-700 dark:text-gray-300 mb-2 animate-pulse">
            Recepcionando pago...
          </h2>
          <p class="text-base text-gray-500 dark:text-gray-400">
            Por favor espera mientras procesamos tu pedido
          </p>
        </div>
      }

      <!-- Success Content -->
      @if (!isReceiving() && showContent()) {
        <div class="fade-in-up">
          <!-- Success Message -->
          <div class="text-center mb-8">
            <div class="inline-flex items-center justify-center w-20 h-20 bg-green-100 dark:bg-green-900/20 rounded-full mb-4 check-animation">
              <span class="material-symbols-outlined text-5xl text-green-600 dark:text-green-400 check-icon">check_circle</span>
            </div>
            <h1 class="text-4xl lg:text-5xl font-black leading-tight tracking-[-0.033em] mb-2 fade-in-delay-1">
              ¡Pedido Confirmado!
            </h1>
            <p class="text-lg text-gray-600 dark:text-gray-400 fade-in-delay-2">
              @if (isStripePayment()) {
                Tu pedido está siendo procesado y preparado con cuidado. Recibirás una notificación cuando esté listo para ser enviado o retirado.
              } @else {
                Tu pedido ha sido registrado correctamente. Para completar la confirmación, por favor adjunta el comprobante de pago siguiendo las instrucciones a continuación.
              }
            </p>
          </div>

          <!-- Order Summary -->
          <div class="bg-white dark:bg-gray-800 rounded-lg border border-border-light dark:border-border-dark p-6 mb-6 fade-in-delay-3">
            <h2 class="text-xl font-bold text-text-primary-light dark:text-text-primary-dark pb-4 mb-4 border-b border-border-light dark:border-border-dark">
              Resumen del Pedido
            </h2>
            
            <!-- Order Items -->
            @if (orderItems.length > 0) {
              <div class="space-y-3 mb-4">
                @for (item of orderItems; track item.productId) {
                  <div class="flex gap-3">
                    <div 
                      class="bg-center bg-no-repeat aspect-square bg-cover rounded-lg size-16 shrink-0" 
                      [style.background-image]="item.productImageUrl ? 'url(' + item.productImageUrl + ')' : 'none'"
                      [style.background-color]="!item.productImageUrl ? '#f3f4f6' : 'transparent'">
                      @if (!item.productImageUrl) {
                        <div class="w-full h-full flex items-center justify-center">
                          <span class="material-symbols-outlined text-gray-400 text-sm">inventory_2</span>
                        </div>
                      }
                    </div>
                    <div class="flex-1">
                      <p class="text-sm font-medium text-text-primary-light dark:text-text-primary-dark">{{ item.productName }}</p>
                      <p class="text-xs text-text-secondary-light dark:text-text-secondary-dark">Cantidad: {{ item.quantity }} × {{ getPriceFormatted(item.unitPrice) }}</p>
                      <p class="text-sm font-bold text-text-primary-light dark:text-text-primary-dark mt-1">{{ getPriceFormatted(item.subtotal) }}</p>
                    </div>
                  </div>
                }
              </div>
            }
            
            <!-- Price Summary -->
            <div class="space-y-2 pt-4 border-t border-border-light dark:border-border-dark">
              <div class="flex justify-between text-sm text-text-secondary-light dark:text-text-secondary-dark">
                <span>Subtotal</span>
                <span>{{ getPriceFormatted(subtotal()) }}</span>
              </div>
              <div class="flex justify-between text-sm text-text-secondary-light dark:text-text-secondary-dark">
                <span>Envío</span>
                <span>{{ getPriceFormatted(shippingCost()) }}</span>
              </div>
              <div class="flex justify-between items-center pt-4 border-t border-border-light dark:border-border-dark">
                <span class="text-lg font-bold text-text-primary-light dark:text-text-primary-dark">Total</span>
                <span class="text-xl font-black text-text-primary-light dark:text-text-primary-dark">{{ getPriceFormatted(total()) }}</span>
              </div>
            </div>
            
            <!-- Order Number -->
            <div class="mt-6 p-4 bg-primary/10 rounded-lg text-center">
              <p class="text-sm font-medium text-text-primary-light dark:text-text-primary-dark mb-1">Número de Pedido</p>
              <p class="text-2xl font-black text-primary font-mono">{{ orderNumber() }}</p>
              <p class="text-xs text-gray-500 dark:text-gray-500 mt-2">
                Guarda este número para seguimiento de tu pedido
              </p>
            </div>
          </div>

          <!-- Order Status Card -->
          <div class="bg-white dark:bg-gray-800 rounded-lg border border-border-light dark:border-border-dark p-6 mb-6 fade-in-delay-4">
            <h2 class="text-xl font-bold text-text-primary-light dark:text-text-primary-dark pb-4 mb-4 border-b border-border-light dark:border-border-dark">
              Estado del Pedido
            </h2>
            
            <div class="space-y-6">
              <!-- Entrega Estimada -->
              <div>
                <h3 class="text-base font-bold text-text-primary-light dark:text-text-primary-dark mb-2">
                  Entrega estimada
                </h3>
                <p class="text-sm text-text-secondary-light dark:text-text-secondary-dark">
                  {{ getEstimatedDeliveryDate() }}
                </p>
                <p class="text-xs text-text-secondary-light dark:text-text-secondary-dark mt-1">
                  {{ shippingData?.shippingMethod === 'pickup' ? 'Listo para retiro en tienda' : 'Entrega a domicilio' }}
                </p>
                <p class="text-xs text-gray-400 dark:text-gray-500 mt-1 italic">
                  Esto es un aproximado
                </p>
              </div>

              <!-- Estado Actual -->
              <div>
                <h3 class="text-base font-bold text-text-primary-light dark:text-text-primary-dark mb-2">
                  Estado actual
                </h3>
                <div class="flex items-center gap-3">
                  <span class="material-symbols-outlined {{ getOrderStatus().color }} text-2xl">
                    {{ getOrderStatus().icon }}
                  </span>
                  <span class="text-sm font-medium {{ getOrderStatus().color }}">
                    {{ getOrderStatus().message }}
                  </span>
                </div>
              </div>

              <!-- Notificación -->
              <div class="pt-4 border-t border-border-light dark:border-border-dark">
                <p class="text-xs text-text-secondary-light dark:text-text-secondary-dark">
                  @if (shippingData?.email) {
                    Recibirás un correo electrónico con el enlace de seguimiento una vez que tu pedido sea despachado.
                  } @else {
                    Recibirás una notificación por WhatsApp con el enlace de seguimiento una vez que tu pedido sea despachado.
                  }
                </p>
              </div>
            </div>
          </div>

          <!-- Payment Instructions (solo si requiere comprobante) -->
          @if (requiresProof() && !isStripePayment()) {
            <div class="space-y-6 fade-in-delay-4">
              <!-- Bank Transfer -->
              @if (paymentData?.paymentMethod === 'bank') {
                <div class="bg-white dark:bg-gray-800 rounded-lg border border-border-light dark:border-border-dark p-6">
                  <h2 class="text-xl font-bold mb-4">Datos para Transferencia Bancaria</h2>
                  <div class="space-y-3 mb-4">
                    <div class="flex justify-between items-center p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
                      <span class="text-sm font-medium text-gray-600 dark:text-gray-400">Banco:</span>
                      <span class="text-sm font-bold text-gray-900 dark:text-white">BCP</span>
                    </div>
                    <div class="flex justify-between items-center p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
                      <span class="text-sm font-medium text-gray-600 dark:text-gray-400">Número de Cuenta:</span>
                      <span class="text-sm font-bold text-gray-900 dark:text-white font-mono">{{ bankAccountNumber }}</span>
                    </div>
                    <div class="flex justify-between items-center p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
                      <span class="text-sm font-medium text-gray-600 dark:text-gray-400">Titular:</span>
                      <span class="text-sm font-bold text-gray-900 dark:text-white">{{ bankAccountName }}</span>
                    </div>
                    <div class="flex justify-between items-center p-3 bg-primary/10 rounded-lg">
                      <span class="text-sm font-medium text-primary">Monto a Transferir:</span>
                      <span class="text-lg font-black text-primary">{{ getPriceFormatted(total()) }}</span>
                    </div>
                  </div>
                  <button 
                    type="button"
                    (click)="copyToClipboard(bankAccountNumber)"
                    [class]="isCopied() 
                      ? 'w-full flex items-center justify-center gap-2 px-4 py-2 bg-green-500 text-white rounded-lg text-sm font-medium transition-all duration-300' 
                      : 'w-full flex items-center justify-center gap-2 px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/90 text-sm font-medium transition-all duration-300'">
                    @if (isCopied()) {
                      <span class="material-symbols-outlined">check_circle</span>
                      <span>¡Copiado!</span>
                    } @else {
                      <span class="material-symbols-outlined">content_copy</span>
                      <span>Copiar Número de Cuenta</span>
                    }
                  </button>
                </div>
              }

              <!-- Digital Wallet -->
              @if (paymentData?.paymentMethod === 'wallet') {
                <div class="bg-white dark:bg-gray-800 rounded-lg border border-border-light dark:border-border-dark p-6">
                  <h2 class="text-xl font-bold mb-4">Pago con Yape</h2>
                  <div class="space-y-4">
                    <!-- QR Code -->
                    @if (yapeQR()) {
                      <div class="flex justify-center">
                        <div class="p-4 bg-white rounded-lg border-2 border-gray-200">
                          <img [src]="yapeQR()" alt="QR Code Yape" class="w-48 h-48 object-contain">
                        </div>
                      </div>
                    }
                    
                    <!-- Wallet Number -->
                    <div class="p-4 bg-gray-50 dark:bg-gray-700 rounded-lg text-center">
                      <p class="text-sm text-gray-600 dark:text-gray-400 mb-1">Número de Yape:</p>
                      <p class="text-2xl font-bold text-primary font-mono">{{ yapeNumber }}</p>
                    </div>
                    
                    <!-- Amount -->
                    <div class="p-4 bg-primary/10 rounded-lg text-center">
                      <p class="text-sm text-gray-600 dark:text-gray-400 mb-1">Monto a Pagar:</p>
                      <p class="text-2xl font-black text-primary">{{ getPriceFormatted(total()) }}</p>
                    </div>
                  </div>
                </div>
              }

              <!-- Instructions -->
              <div class="bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg p-6">
                <h3 class="text-lg font-bold text-blue-900 dark:text-blue-100 mb-3">Instrucciones para Finalizar tu Pago</h3>
                <ol class="space-y-2 text-sm text-blue-800 dark:text-blue-200 list-decimal list-inside">
                  <li>Realiza el pago utilizando los datos de cuenta o QR mostrados arriba</li>
                  <li>Verifica que el monto sea exactamente: <strong>{{ getPriceFormatted(total()) }}</strong></li>
                  <li>Completa la transacción en tu aplicación bancaria o billetera digital</li>
                  <li>Guarda una captura de pantalla o descarga el comprobante de pago</li>
                  <li>Haz clic en el botón "Confirmar Compra por WhatsApp"</li>
                  <li>Se abrirá WhatsApp con un mensaje prellenado</li>
                  <li>Agrega tus datos de contacto (nombre completo, teléfono y correo electrónico)</li>
                  <li>Adjunta el comprobante de pago y envía el mensaje</li>
                </ol>
                <div class="mt-4 p-3 bg-blue-100 dark:bg-blue-800/30 rounded-lg">
                  <p class="text-sm text-blue-900 dark:text-blue-100">
                    <strong>Importante:</strong> Tu pedido está registrado en nuestro sistema. Una vez que recibamos y verifiquemos tu comprobante, nuestro equipo procesará tu pedido de inmediato para agilizar la entrega.
                  </p>
                </div>
              </div>

              <!-- WhatsApp Button -->
              <button 
                type="button"
                (click)="openWhatsApp()"
                class="w-full flex items-center justify-center gap-3 px-6 py-4 bg-green-500 text-white rounded-lg hover:bg-green-600 text-lg font-bold shadow-lg transition-colors">
                <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
                  <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413Z"/>
                </svg>
                <span>Confirmar Compra por WhatsApp</span>
              </button>
            </div>
          }

          <!-- Stripe Success (sin comprobante) -->
          @if (isStripePayment()) {
            <div class="bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800 rounded-lg p-6 text-center fade-in-delay-4">
              <p class="text-green-800 dark:text-green-200 mb-4">
                Tu pago ha sido procesado exitosamente. Recibirás un email de confirmación con los detalles de tu pedido.
              </p>
              <p class="text-sm text-green-700 dark:text-green-300">
                Te notificaremos cuando tu pedido esté listo para envío o retiro.
              </p>
            </div>
          }

          <!-- Actions -->
          <div class="flex flex-col sm:flex-row gap-4 mt-8 fade-in-delay-5">
            <a 
              routerLink="/tienda/productos"
              class="flex-1 flex items-center justify-center gap-2 px-6 py-3 border-2 border-primary text-primary rounded-lg hover:bg-primary/5 font-bold transition-colors">
              <span class="material-symbols-outlined">shopping_bag</span>
              Seguir Comprando
            </a>
            <a 
              routerLink="/"
              class="flex-1 flex items-center justify-center gap-2 px-6 py-3 bg-primary text-white rounded-lg hover:bg-primary/90 font-bold transition-colors">
              <span class="material-symbols-outlined">home</span>
              Ir al Inicio
            </a>
          </div>
        </div>
      }
    </div>
  </main>
</div>

